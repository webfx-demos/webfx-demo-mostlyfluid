name: Multi-OS builds
########################################################################################################################
#          This Github workflow will generate the following builds on each push made on the main branch:               #
########################################################################################################################
# Builds generated on Ubuntu:                                                                                          #
#  1) App-Linux-x64.jar : Java archive (fat jar with JavaFx for Linux)                                                 #
#  2) App-Web.war : Web app (built with GWT)                                                                           #
#  3) App-Linux-x64-executable : Linux desktop native app (built with Gluon)                                           #
#  4) App-Android-aarch64.apk : Android native app (built with Gluon)                                                  #
# Builds generated on Windows:                                                                                         #
#  5) App-Windows-x64.jar : Java archive (fat jar with JavaFx for Windows)                                             #
#  6) App-Windows-x64.msi : Windows installer (msi)                                                                    #
#  7) App-Windows-x64.exe : Windows desktop native app (Gluon)                                                         #
# Builds generated on MacOS:                                                                                           #
#  8) App-macOS-x64.jar : Java archive (fat jar with JavaFx for MacOS)                                                 #
#  9) App-macOS-x64-executable : MacOS desktop native app (Gluon)                                                      #
# 10) App-iOS-arm64.ipa : iOS native app (Gluon)                                                                       #
########################################################################################################################

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        app: [{name: 'ResponsiveDesign', module-token: 'responsivedesign', bundle-id: 'org.webfx.demo.responsivedesign'}]
        os-config:  [1, 2, 3, 4]
        include:
          - os-config: 1 # Generates builds 1) 2) & 3)
            os: ubuntu-latest
            fatjar-artifact-suffix:        'Linux-x64.jar'
            web-artifact-suffix:           'Web.war' # Must run on Linux because the Web branch push action runs only on Linux
            gluon-desktop-arch-token:      'x86_64-linux'
            gluon-desktop-artifact-suffix: 'Linux-x64-native-runnable'
            jvmbundle-deb-artifact-suffix: 'Linux-x64-jvmbundle.deb'
            jvmbundle-rpm-artifact-suffix: 'Linux-x64-jvmbundle.rpm'

          - os-config: 2 # Generates builds 4) - Could be in os-config 1 but moving these builds to this parallel run to speeds up the
            os: ubuntu-latest
            gluon-android-arch-token:      'aarch64-android'
            gluon-android-artifact-suffix: 'Android-aarch64-native.apk'

          - os-config: 3 # Generates builds 5) 6) & 7)
            os: windows-latest
            fatjar-artifact-suffix:        'Windows-x64.jar'
            gluon-desktop-arch-token:      'x86_64-windows'
            gluon-desktop-artifact-suffix: 'Windows-x64-native.exe'
            msi-desktop-artifact-suffix:   'Windows-x64-jvmbundle.msi'
            jvmbundle-exe-artifact-suffix: 'Windows-x64-jvmbundle.exe'
            jvmbundle-msi-artifact-suffix: 'Windows-x64-jvmbundle.msi'

          - os-config: 4 # Generates builds 8) 9) & 10)
            os: macos-latest
            fatjar-artifact-suffix:        'MacOS-x64.jar'
            gluon-desktop-arch-token:      'x86_64-darwin'
            gluon-desktop-Artifact-suffix: 'MacOS-x64-native-runnable'
            # The iOS build needs the Apple certificate in secrets (steps will be skipped otherwise)
            gluon-ios-arch-token:          'arm64-ios'
            gluon-ios-artifact-suffix:     'iOS-arm64-native.ipa'
            jvmbundle-dmg-artifact-suffix:  'MacOS-x64-jvmbundle.dmg'
            jvmbundle-pkg-artifact-suffix:  'MacOS-x64-jvmbundle.pkg'

    env:
      application-name: ${{ matrix.app.name }}
      webfx-module:     ./webfx
      javafx-module:    ./webfx-demo-${{ matrix.app.module-token }}-application-javafx
      gwt-module:       ./webfx-demo-${{ matrix.app.module-token }}-application-gwt
      gwt-build:        ./webfx-demo-${{ matrix.app.module-token }}-application-gwt/target/webfx-demo-${{ matrix.app.module-token }}-application-gwt-0.1.0-SNAPSHOT/webfx_demo_${{ matrix.app.module-token }}_application_gwt/
      gluon-module:     ./webfx-demo-${{ matrix.app.module-token }}-application-gluon
      web-push-repository-name: webfx-demo-${{ matrix.app.module-token }} # This same repository
      web-push-repository-owner: ${{ github.repository_owner }}
      web-push-branch: 'web-build'
      web-push-username: ${{ github.actor }}
      web-push-email: ${{ secrets.API_GITHUB_EMAIL }}
      jdk-version: '15.0.1'
      xcode-version: '11.7.0'
      graalvm-version: '20.3.0.java11'
      API_GITHUB_TOKEN: ${{ secrets.API_GITHUB_TOKEN }}
      GLUON_LICENSE: ${{ secrets.GLUON_LICENSE }}
      GLUON_IOS_CERTIFICATES_FILE_BASE64: ${{ secrets.GLUON_IOS_CERTIFICATES_FILE_BASE64 }}
      GLUON_IOS_APPSTORE_KEY_ID: ${{ secrets.GLUON_IOS_APPSTORE_KEY_ID }}

    steps:

      ##################################################################################################################
      #                                              Preparation                                                       #
      ##################################################################################################################

      # Configure Git for long filenames on Windows (otherwise the WebFx repository checkout will fail)
      - if: runner.os == 'Windows'
        name: Configure Git for long filenames (Windows only)
        run: git config --global core.longpaths true

      # Checkout this repository (before WebFx repository because this checkout would erase the WebFx folder)
      - name: Checkout this repository
        uses: actions/checkout@v2

      # Checkout WebFx repository (we need to build it as a prerequisite because there is no release yet)
      - name: Checkout WebFx repository
        uses: actions/checkout@v2
        with:
          repository: 'webfx-project/webfx'
          path: ${{ env.webfx-module }}

      # Set up the JDK (WebFx requires JDK13+ due to javac bugs in prior versions - otherwise JDK11+ should be enough in theory)
      - name: Set up JDK ${{ env.jdk-version }}
        uses: actions/setup-java@v1
        with:
          java-version: ${{ env.jdk-version }}


      ##################################################################################################################
      #             Building WebFx + this repository (jars + javafx fat jar + Web build (GWT) if required)             #
      ##################################################################################################################
      #  1) App-Linux-x64.jar : Java archive (fat jar with JavaFx for Linux)                                           #
      #  2) App-Web.war : Web app (built with GWT)                                                                     #
      #  5) App-Windows-x64.jar : Java archive (fat jar with JavaFx for Windows)                                       #
      #  8) App-macOS-x64.jar : Java archive (fat jar with JavaFx for MacOS)                                           #
      ##################################################################################################################

      # Building the latest WebFx version locally (since there is no public release yet)
      - name: Build WebFx with JDK ${{ env.jdk-version }} (Java 11 target)
        run: mvn -P '!gwt-compile' install
        working-directory: ${{ env.webfx-module }}

      # Building this repository with JDK 13+ (Java 11 target) including a GWT compilation (if required)
      - if: matrix.web-artifact-suffix != null
        name: Build this repository (JavaFx fat jar + GWT build)
        run: mvn -P 'gwt-compile,javafx-fatjar,javapackager' install

      # Or building this repository with JDK 13+ (Java 11 target) excluding a GWT compilation
      - if: matrix.web-artifact-suffix == null
        name: Build this repository (JavaFx fat jar - no GWT build)
        run: mvn -P '!gwt-compile,javafx-fatjar,javapackager' install


      ##################################################################################################################
      #                               Uploading fat jar (with JavaFx) artifacts                                        #
      ##################################################################################################################
      #  1) App-Linux-x64.jar : Java archive (fat jar with JavaFx for Linux)                                           #
      #  5) App-Windows-x64.jar : Java archive (fat jar with JavaFx for Windows)                                       #
      #  8) App-macOS-x64.jar : Java archive (fat jar with JavaFx for MacOS)                                           #
      ##################################################################################################################


      # Uploading 1)
      - if: matrix.fatjar-artifact-suffix != null
        name: Upload this fat jar artifact as asset of this worflow run
        uses: actions/upload-artifact@v2
        with:
          name: ${{ env.application-name }}-${{ matrix.fatjar-artifact-suffix }}
          path: ${{ env.javafx-module }}/target/*-fat.jar

      - if: jvmbundle-deb-artifact-suffix != null
        uses: actions/upload-artifact@v2
        with:
          name: ${{ env.application-name }}-${{ matrix.jvmbundle-deb-artifact-suffix }}
          path: ${{ env.javafx-module }}/target/javapackager/*.deb

      - if: matrix.jvmbundle-rpm-artifact-suffix != null
        uses: actions/upload-artifact@v2
        with:
          name: ${{ env.application-name }}-${{ matrix.jvmbundle-rpm-artifact-suffix }}
          path: ${{ env.javafx-module }}/target/javapackager/*.rpm

      - if: matrix.jvmbundle-exe-artifact-suffix != null
        uses: actions/upload-artifact@v2
        with:
          name: ${{ env.application-name }}-${{ matrix.jvmbundle-exe-artifact-suffix }}
          path: ${{ env.javafx-module }}/target/javapackager/*.exe

      - if: matrix.jvmbundle-msi-artifact-suffix != null
        uses: actions/upload-artifact@v2
        with:
          name: ${{ env.application-name }}-${{ matrix.jvmbundle-msi-artifact-suffix }}
          path: ${{ env.javafx-module }}/target/javapackager/*.msi

      - if: matrix.jvmbundle-dmg-artifact-suffix != null
        uses: actions/upload-artifact@v2
        with:
          name: ${{ env.application-name }}-${{ matrix.jvmbundle-dmg-artifact-suffix }}
          path: ${{ env.javafx-module }}/target/javapackager/*.dmg

      - if: matrix.jvmbundle-pkg-artifact-suffix != null
        uses: actions/upload-artifact@v2
        with:
          name: ${{ env.application-name }}-${{ matrix.jvmbundle-pkg-artifact-suffix }}
          path: ${{ env.javafx-module }}/target/javapackager/*.pkg


      ##################################################################################################################
      #                                      Uploading the Web artifact                                                #
      ##################################################################################################################
      #  2) App-Web.war : Web app (built with GWT)                                                                     #
      ##################################################################################################################

      # Uploading it in the assets of this workflow run
      - if: matrix.web-artifact-suffix != null
        name: Upload GWT build as an artifact of this workflow run
        uses: actions/upload-artifact@v2
        with:
          name: ${{ env.application-name }}-${{ matrix.web-artifact-suffix }}
          path: ${{ env.gwt-module }}/target/*.war


      ##################################################################################################################
      #                        Updating the Web build branch (will update the live demo)                               #
      ##################################################################################################################

      - if: matrix.web-artifact-suffix != null && env.API_GITHUB_TOKEN != ''
        name: Push GWT build to ${{ env.web-push-branch }} branch
        uses: cpina/github-action-push-to-another-repository@master
        env:
          API_TOKEN_GITHUB: ${{ secrets.API_GITHUB_TOKEN }}
        with:
          source-directory: ${{ env.gwt-build }}
          destination-repository-username: ${{ env.web-push-repository-owner }}
          destination-repository-name: ${{ env.web-push-repository-name }}
          target-branch: ${{ env.web-push-branch }}
          destination-github-username: ${{ env.web-push-username }}
          user-email: ${{ env.web-push-email }}


      ##################################################################################################################
      #                                  Building the Windows installer (msi)                                          #
      ##################################################################################################################
      #  6) App-Windows-x64.msi : Windows installer (msi)                                                              #
      ##################################################################################################################

      # Creating the runtime with jlink and msi with jpackage
      # ${{ env.JAVA_HOME }}\bin\jlink -p "${{ env.JAVA_HOME }}\jmods" --add-modules java.desktop --strip-debug --no-header-files --no-man-pages --strip-native-commands --vm=server --compress=2 --output jlinkImage
      - if: matrix.msi-desktop-artifact-suffix != null
        name: Create Windows Installer (msi)
        run: |
          mvn javafx:jlink
          ${{ env.JAVA_HOME }}\bin\jpackage --input .\target\ --name ${{ env.application-name }} --main-jar webfx-demo-${{ matrix.app.module-token }}-application-javafx-0.1.0-SNAPSHOT.jar --main-class webfx.platform.shared.services.appcontainer.ApplicationContainer --type msi --runtime-image .\target\jlinkImage --app-version 0.0.0 --win-per-user-install --win-menu --win-menu-group WebFx
        working-directory: ${{ env.javafx-module }}


      ##################################################################################################################
      #                                 Uploading the Windows installer (msi)                                          #
      ##################################################################################################################
      #  6) App-Windows-x64.msi : Windows installer (msi)                                                              #
      ##################################################################################################################

      # Uploading it in the assets of this workflow run
      - if: matrix.msi-desktop-artifact-suffix != null
        name: Upload Windows installer
        uses: actions/upload-artifact@v2
        with:
          name: ${{ env.application-name }}-${{ matrix.msi-desktop-artifact-suffix }}
          path: ${{ env.javafx-module }}/*.msi


      ##################################################################################################################
      #                           Building the native desktop apps using Gluon/GraalVM                                 #
      ##################################################################################################################
      #  3) App-Linux-x64-executable : Linux desktop native app (built with Gluon)                                     #
      #  7) App-Windows-x64.exe : Windows desktop native app (Gluon)                                                   #
      #  9) App-macOS-x64-executable : MacOS desktop native app (Gluon)                                                #
      ##################################################################################################################

      # Windows prerequisite: msbuild
      - if: runner.os == 'Windows'
        name: Add msbuild to PATH (Windows only)
        uses: microsoft/setup-msbuild@v1.0.2

      # Windows prerequisite: Visual Studio shell
      - if: runner.os == 'Windows'
        name: Visual Studio shell (Windows only)
        uses: egor-tensin/vs-shell@v1

      # MacOS prerequisite: Xcode
      - if: runner.os == 'macOS'
        name: Set up Xcode ${{ env.xcode-version }} (MacOS only)
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.xcode-version }}

      # Setting up the GraalVM environment
      - name: Set up GraalVM environment ${{ env.graalvm-version }}
        uses: DeLaGuardo/setup-graalvm@master
        with:
          graalvm-version: ${{ env.graalvm-version }}

      # Gluon needs additional libraries on Linux
      - if: runner.os == 'Linux'
        name: Install libraries required for Gluon on Linux
        run: sudo apt install libasound2-dev libavcodec-dev libavformat-dev libavutil-dev libgl-dev libgtk-3-dev libpango1.0-dev libxtst-dev

      # Passing the Gluon License (if set)
      - if: env.GLUON_LICENSE != ''
        name: Gluon License
        uses: gluonhq/gluon-build-license@v1
        with:
          gluon-license: ${{ secrets.GLUON_LICENSE }}

      # Invoking the Gluon Client Maven plugin to build the native Desktop app (chaining build & package goals)
      - if: matrix.gluon-desktop-artifact-suffix != null
        name: Gluon Build for Desktop
        run: mvn -P 'gluon-desktop' client:build client:package # May take a while
        env:
          GRAALVM_HOME: ${{ env.JAVA_HOME }}
        working-directory: ${{ env.gluon-module }}


      ##################################################################################################################
      #                                   Uploading the native desktop apps                                            #
      ##################################################################################################################
      #  3) App-Linux-x64-executable : Linux desktop native app (built with Gluon)                                     #
      #  7) App-Windows-x64.exe : Windows desktop native app (Gluon)                                                   #
      #  9) App-macOS-x64-executable : MacOS desktop native app (Gluon)                                                #
      ##################################################################################################################

      # Uploading it in the assets of this workflow run
      - if: matrix.gluon-desktop-artifact-suffix != null && runner.os != 'Windows'
        name: Upload native Desktop as an artifact of this workflow run
        uses: actions/upload-artifact@v2
        with:
          name: ${{ env.application-name }}-${{ matrix.gluon-desktop-artifact-suffix }}
          path: ${{ env.gluon-module }}/target/client/${{ matrix.gluon-desktop-arch-token }}/webfx-demo-*

      # Uploading it in the assets of this workflow run
      - if: matrix.gluon-desktop-artifact-suffix != null && runner.os != 'Windows'
        name: Upload native Desktop as an artifact of this workflow run
        uses: actions/upload-artifact@v2
        with:
          name: ${{ env.application-name }}-${{ matrix.gluon-desktop-artifact-suffix }}
          path: ${{ env.gluon-module }}/target/client/${{ matrix.gluon-desktop-arch-token }}/*.exe


      ##################################################################################################################
      #                            Building the native Android app using Gluon/GraalVM                                 #
      ##################################################################################################################
      #  4) App-Android-aarch64.apk : Android native app (built with Gluon)                                            #
      ##################################################################################################################

      # All prerequisite have already be done when building the Desktop qpps

      # Invoking the Gluon Client Maven plugin to build the native Android app (chaining build & package goals)
      - if: matrix.gluon-android-arch-token != null
        name: Gluon Build for Android
        run: mvn -P 'gluon-android' clean client:build client:package # May take a while
        env:
          GRAALVM_HOME: ${{ env.JAVA_HOME }}
        working-directory: ${{ env.gluon-module }}


      ##################################################################################################################
      #                                   Uploading the native Android app                                             #
      ##################################################################################################################
      #  4) App-Android-aarch64.apk : Android native app (built with Gluon)                                            #
      ##################################################################################################################

      # Uploading it in the assets of this workflow run
      - if: matrix.gluon-android-arch-token != null
        name: Upload Android native application as an artifact of this workflow run
        uses: actions/upload-artifact@v2
        with:
          name: ${{ env.application-name }}-${{ matrix.gluon-android-artifact-suffix }}
          path: ${{ env.gluon-module }}/target/client/${{ matrix.gluon-android-arch-token }}/gvm/*.apk


      ##################################################################################################################
      #                              Building the native iOS app using Gluon/GraalVM                                   #
      ##################################################################################################################
      # 10) App-iOS-arm64.ipa : iOS native app (Gluon)                                                                 #
      ##################################################################################################################

      # Importing the Apple codesign certificates
      - if: env.GLUON_IOS_CERTIFICATES_FILE_BASE64 != ''
        uses: Apple-Actions/import-codesign-certs@v1
        with:
          p12-file-base64: ${{ secrets.GLUON_IOS_CERTIFICATES_FILE_BASE64 }}
          p12-password: ${{ secrets.GLUON_IOS_CERTIFICATES_PASSWORD }}

      # Importing the Apple codesign certificates
      - if: env.GLUON_IOS_APPSTORE_KEY_ID != ''
        uses: Apple-Actions/download-provisioning-profiles@v1
        with:
          bundle-id: ${{ matrix.app.bundle-id }}
          issuer-id: ${{ secrets.GLUON_IOS_APPSTORE_ISSUER_ID }}
          api-key-id: ${{ secrets.GLUON_IOS_APPSTORE_KEY_ID }}
          api-private-key: ${{ secrets.GLUON_IOS_APPSTORE_PRIVATE_KEY }}

      # Invoking the Gluon Client Maven plugin to build the native iOS app (chaining build & package goals)
      - if: matrix.gluon-ios-arch-token != null && env.GLUON_IOS_CERTIFICATES_FILE_BASE64 != ''
        name: Gluon Build for iOS
        run: mvn -P 'gluon-ios' clean client:build client:package # May take a while
        env:
          GRAALVM_HOME: ${{ env.JAVA_HOME }}
        working-directory: ${{ env.gluon-module }}


      ##################################################################################################################
      #                                     Uploading the native iOS app                                               #
      ##################################################################################################################
      # 10) App-iOS-arm64.ipa : iOS native app (Gluon)                                                                 #
      ##################################################################################################################

      # Uploading it in the assets of this workflow run
      - if: matrix.gluon-ios-arch-token != null && env.GLUON_IOS_CERTIFICATES_FILE_BASE64 != ''
        name: Upload iOS native application as an artifact of this workflow run
        uses: actions/upload-artifact@v2
        with:
          name: ${{ env.application-name }}-${{ matrix.gluon-ios-artifact-suffix }}
          path: ${{ env.gluon-module }}/target/client/${{ matrix.gluon-ios-arch-token }}/gvm/*.ipa


      ##################################################################################################################
      #                             Publishing the native iOS app in the Apple Store                                   #
      ##################################################################################################################
      # 10) App-iOS-arm64.ipa : iOS native app (Gluon)                                                                 #
      ##################################################################################################################

      - if: env.GLUON_IOS_APPSTORE_KEY_ID != ''
        uses: Apple-Actions/upload-testflight-build@master
        with:
          app-path: ${{ env.gluon-module }}/target/client/${{ matrix.gluon-ios-arch-token }}/gvm/*.ipa
          issuer-id: ${{ secrets.GLUON_IOS_APPSTORE_ISSUER_ID }}
          api-key-id: ${{ secrets.GLUON_IOS_APPSTORE_KEY_ID }}
          api-private-key: ${{ secrets.GLUON_IOS_APPSTORE_PRIVATE_KEY }}


      ##################################################################################################################
      #                      Uploading all generated artifacts into the SNAPSHOT release assets                        #
      ##################################################################################################################
      #  1) App-Linux-x64.jar : Java archive (fat jar with JavaFx for Linux)                                           #
      #  2) App-Web.war : Web app (built with GWT)                                                                     #
      #  3) App-Linux-x64-executable : Linux desktop native app (built with Gluon)                                     #
      #  4) App-Android-aarch64.apk : Android native app (built with Gluon)                                            #
      #  5) App-Windows-x64.jar : Java archive (fat jar with JavaFx for Windows)                                       #
      #  6) App-Windows-x64.msi : Windows installer (msi)                                                              #
      #  7) App-Windows-x64.exe : Windows desktop native app (Gluon)                                                   #
      #  8) App-macOS-x64.jar : Java archive (fat jar with JavaFx for MacOS)                                           #
      #  9) App-macOS-x64-executable : MacOS desktop native app (Gluon)                                                #
      # 10) App-iOS-arm64.ipa : iOS native app (Gluon)                                                                 #
      ##################################################################################################################

  upload:
    needs: build
    runs-on: ubuntu-latest
    env:
      API_GITHUB_TOKEN: ${{ secrets.API_GITHUB_TOKEN }}

    steps:

      # The staging directory will be used to download all artifacts generated by the build job and to upload them in the SNAPSHOT release
      - name: Make staging directory
        run: mkdir /staging

      # Downloading the artifacts generated by the build job in to the staging directory
      - if: env.API_GITHUB_TOKEN != ''
        name: Download artifacts into staging directory
        uses: actions/download-artifact@v2
        with:
          path: /staging

      # Clearing SNAPSHOT release assets
      - if: env.API_GITHUB_TOKEN != ''
        name: Delete old assets in SNAPSHOT release
        uses: mknejp/delete-release-assets@v1
        with:
          tag: SNAPSHOT
          assets: '*'
          fail-if-no-assets: false
          token: ${{ secrets.API_GITHUB_TOKEN }}

      # Upload new artifacts into the SNAPSHOT release assets
      - if: env.API_GITHUB_TOKEN != ''
        name: Upload artifacts to the SNAPSHOT release assets
        uses: AButler/upload-release-assets@v2.0
        with:
          release-tag: SNAPSHOT
          files: /staging/*
          repo-token: ${{ secrets.API_GITHUB_TOKEN }}